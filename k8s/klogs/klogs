#!/bin/bash

# Exit immediately on error
set -e

# --- Defaults ---
NAMESPACE="identity"
ENV=""
PREFIX=""
SAVE_LOGS=false

# --- Parse arguments ---
for arg in "$@"; do
  case $arg in
    --prefix=*)
      PREFIX="${arg#*=}"
      shift
      ;;
    --env=*)
      ENV="${arg#*=}"
      shift
      ;;
    --namespace=*)
      NAMESPACE="${arg#*=}"
      shift
      ;;
    -s)
      SAVE_LOGS=true
      shift
      ;;
    *)
      echo "‚ùå Unknown argument: $arg"
      exit 1
      ;;
  esac
done

# --- Validate required arguments ---
if [[ -z "$PREFIX" ]]; then
  echo "‚ùå Missing required argument: --prefix"
  exit 1
fi

# ---  Check kubectl session ---
echo "üîç Checking kubectl session in namespace '$NAMESPACE'..."
if ! kubectl auth can-i get pods -n "$NAMESPACE" &>/dev/null; then
  echo "‚ö†Ô∏è No valid kubectl session detected. Attempting Azure login..."
  az login || { echo "‚ùå Azure login failed. Aborting."; exit 1; }

  # Re-check session
  if ! kubectl auth can-i get pods -n "$NAMESPACE" &>/dev/null; then
    echo "‚ùå kubectl session is still invalid after az login. Aborting."
    exit 1
  else
    echo "‚úÖ kubectl session is now valid."
  fi
else
  echo "‚úÖ kubectl session is valid for namespace '$NAMESPACE'."
fi

# --- Set Azure environment ---
export AZURE_CONFIG_DIR="$HOME/.azure-bp"
echo "üè¶ Azure environment switched to Banco Pichincha (AZURE_CONFIG_DIR=$AZURE_CONFIG_DIR)"

# --- Handle --env (optional) ---
if [[ -n "$ENV" ]]; then
  case "$ENV" in
    dev)
      CONTEXT="aks-dev-coe-seguridad"
      ;;
    test)
      CONTEXT="aks-test-coe-seguridad"
      ;;
    prod)
      CONTEXT="aks-prod-coe-seguridad"
      ;;
    *)
      echo "‚ùå Invalid --env value. Allowed: dev, test, prod"
      exit 1
      ;;
  esac
  echo "üîÑ Switching Kubernetes context to: $CONTEXT"
  kubectl config use-context "$CONTEXT"
fi

# --- List matching pods ---
echo "üîç Searching for pods in namespace '$NAMESPACE' with prefix '${PREFIX}-'..."
PODS=$(kubectl get pods -n "$NAMESPACE" --no-headers -o custom-columns=":metadata.name" | grep "${PREFIX}-" || true)

if [ -z "$PODS" ]; then
  echo "‚ö†Ô∏è No pods found with prefix '${PREFIX}-' in namespace '$NAMESPACE'."
  exit 1
fi

# --- Validate prefix consistency ---
FIRST_POD=$(echo "$PODS" | head -n 1)
BASE_NAME="${FIRST_POD%-*}"
VALID_PATTERN="^${BASE_NAME}-[a-zA-Z0-9]{1,15}$"

echo "üîé Validating all pods match pattern: $VALID_PATTERN"

ALL_VALID=true
INVALID_PODS=()

while IFS= read -r POD; do
  if [[ ! "$POD" =~ $VALID_PATTERN ]]; then
    INVALID_PODS+=("$POD")
    ALL_VALID=false
  fi
done <<< "$PODS"

if [ "$ALL_VALID" = false ]; then
  echo "‚ùå The following pods do NOT match the expected pattern based on first pod '$FIRST_POD':"
  for pod in "${INVALID_PODS[@]}"; do
    echo " - $pod"
  done
  echo "üö´ Aborting log stream."
  exit 1
fi

# --- Stream logs (with optional save) ---
LOG_DIR="$HOME/Workspace/logs"
mkdir -p "$LOG_DIR"
TIMESTAMP=$(date +"%d%m%Y%H%M%S")

echo "üì¶ Streaming logs from valid pods..."
while IFS= read -r POD; do
  echo "üìÑ Streaming logs for pod: $POD"
  if $SAVE_LOGS; then
    SHORT_NAME="${POD%-*}"
    LOG_FILE="$LOG_DIR/${SHORT_NAME}-${ENV}-${TIMESTAMP}.log"
    echo "üíæ Saving logs to: $LOG_FILE"
    kubectl logs -n "$NAMESPACE" -f "$POD" | tee -a "$LOG_FILE" &
  else
    kubectl logs -n "$NAMESPACE" -f "$POD" &
  fi
done <<< "$PODS"

wait
